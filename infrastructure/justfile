# Infrastructure Commands - NestJS Docker Backend

# Development commands
dev-up:
    @echo "🚀 Starting development environment..."
    @./scripts/setup-dev.sh

dev-down:
    @echo "🛑 Stopping development environment (preserving data)..."
    @docker compose -f docker/docker-compose.dev.yml down --remove-orphans

dev-down-clean:
    @echo "🧹 Stopping development environment and removing all data..."
    @docker compose -f docker/docker-compose.dev.yml down -v --remove-orphans

dev-logs:
    @docker compose -f docker/docker-compose.dev.yml logs -f

dev-restart:
    @echo "🔄 Restarting development environment..."
    @just dev-down
    @just dev-up

dev-restart-clean:
    @echo "🔄 Restarting development environment (fresh start)..."
    @just dev-down-clean
    @just dev-up

# Production commands  
prod-up:
    @echo "🚀 Starting production environment..."
    @./scripts/setup-prod.sh

prod-down:
    @echo "🛑 Stopping production environment..."
    @docker compose -f docker/docker-compose.prod.yml down
    @docker compose -f docker/docker-compose.traefik.yml down

prod-logs:
    @docker compose -f docker/docker-compose.prod.yml logs -f

prod-app-only:
    @echo "🚀 Starting production app only (Traefik already running)..."
    @docker compose -f docker/docker-compose.prod.yml up -d

prod-traefik-only:
    @echo "🚀 Starting Traefik only..."
    @docker compose -f docker/docker-compose.traefik.yml up -d

# Application commands (running in app directory)
app-install:
    @echo "📦 Installing application dependencies..."
    @cd ../app && npm install

app-dev:
    @echo "🚀 Starting application in development mode..."
    @cd ../app && npm run start:dev

app-build:
    @echo "🔨 Building application..."
    @cd ../app && npm run build

app-test:
    @echo "🧪 Running application tests..."
    @cd ../app && npm test

app-test-e2e:
    @echo "🧪 Running end-to-end tests..."
    @cd ../app && npm run test:e2e

# Admin panel commands
admin-install:
    @echo "📦 Installing admin panel dependencies..."
    @cd ../admin && npm install

admin-dev:
    @echo "🚀 Starting admin panel in development mode..."
    @cd ../admin && npm run dev

admin-build:
    @echo "🔨 Building admin panel..."
    @cd ../admin && npm run build

admin-logs:
    @docker logs admin-panel-dev -f

# Service-specific commands
dev-logs-app:
    @docker compose -f docker/docker-compose.dev.yml logs -f app

dev-logs-admin:
    @docker compose -f docker/docker-compose.dev.yml logs -f admin

dev-logs-db:
    @docker compose -f docker/docker-compose.dev.yml logs -f postgres

dev-rebuild:
    @echo "🔨 Rebuilding development containers..."
    @docker compose -f docker/docker-compose.dev.yml build --no-cache

dev-rebuild-admin:
    @echo "🔨 Rebuilding admin panel container..."
    @docker compose -f docker/docker-compose.dev.yml build --no-cache admin

# Database commands
db-reset:
    @echo "🗄️ Resetting database (removes all data)..."
    @docker compose -f docker/docker-compose.dev.yml stop postgres
    @docker compose -f docker/docker-compose.dev.yml rm -f postgres
    @docker volume rm docker_postgres_data || true
    @docker compose -f docker/docker-compose.dev.yml up -d postgres

# Utility commands
clean:
    @echo "🧹 Cleaning up Docker resources..."
    @docker system prune -f
    @docker volume prune -f

clean-all:
    @echo "🧹 Deep cleaning Docker resources (removes everything)..."
    @docker system prune -af
    @docker volume prune -f

build:
    @echo "🔨 Building production Docker images..."
    @docker compose -f docker/docker-compose.prod.yml build --no-cache

ssl-certs:
    @echo "🔐 Generating SSL certificates for development..."
    @cd traefik/certs && mkcert "*.interestingapp.local" interestingapp.local

open-services:
    @echo "🌐 Opening development services in browser..."
    @open https://admin.interestingapp.local
    @open https://api.interestingapp.local/api/docs
    @open https://mail.interestingapp.local
    @open https://pgadmin.interestingapp.local
    @open https://traefik.interestingapp.local

# Environment management
env-setup:
    @echo "📋 Setting up environment files..."
    @cp .env.example .env.development
    @cp .env.production.example .env.production
    @echo "✅ Edit .env.development and .env.production with your values"

# Help command
help:
    @echo "🚀 Infrastructure Commands - NestJS Docker Backend"
    @echo ""
    @echo "📋 Development Environment:"
    @echo "  dev-up            - Start development environment with HTTPS"
    @echo "  dev-down          - Stop development environment (preserves data)"
    @echo "  dev-down-clean    - Stop and remove all data (fresh start)"
    @echo "  dev-logs          - Follow all development logs"
    @echo "  dev-restart       - Restart development environment (preserves data)"
    @echo "  dev-restart-clean - Restart with fresh data"
    @echo ""
    @echo "🚀 Production Environment:"
    @echo "  prod-up               - Start production (Traefik + App)"
    @echo "  prod-down             - Stop production environment"
    @echo "  prod-logs             - Follow production logs"
    @echo "  prod-app-only         - Start only the app (Traefik running separately)"
    @echo "  prod-traefik-only     - Start only Traefik"
    @echo ""
    @echo "🛠️  Application Development:"
    @echo "  app-install   - Install application dependencies"
    @echo "  app-dev       - Start app in development mode (without Docker)"
    @echo "  app-build     - Build application"
    @echo "  app-test      - Run application tests"
    @echo "  app-test-e2e  - Run end-to-end tests"
    @echo ""
    @echo "🎨 Admin Panel:"
    @echo "  admin-install - Install admin panel dependencies"
    @echo "  admin-dev     - Start admin panel in development mode"
    @echo "  admin-build   - Build admin panel"
    @echo "  admin-logs    - View admin panel logs"
    @echo ""
    @echo "🔧 Service-Specific Commands:"
    @echo "  dev-logs-app      - Follow app container logs"
    @echo "  dev-logs-admin    - Follow admin panel logs"
    @echo "  dev-logs-db       - Follow database logs"
    @echo "  dev-rebuild       - Rebuild all development containers"
    @echo "  dev-rebuild-admin - Rebuild only admin panel container"
    @echo ""
    @echo "🗄️  Database Commands:"
    @echo "  db-reset          - Reset database (removes all data)"
    @echo ""
    @echo "🧹 Utilities:"
    @echo "  build         - Build production Docker images"
    @echo "  clean         - Clean up unused Docker resources"
    @echo "  clean-all     - Deep clean Docker resources (removes everything)"
    @echo "  ssl-certs     - Generate development SSL certificates"
    @echo "  open-services - Open all development services in browser"
    @echo "  env-setup     - Create environment files from examples"